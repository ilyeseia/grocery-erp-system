// Grocery Store ERP System - Prisma Schema
// Production-ready database design with proper relations
// Enhanced with multi-branch, returns, shifts, permissions, and more

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id             String   @id @default(cuid())
  name           String
  email          String   @unique
  passwordHash   String
  role           UserRole @default(CASHIER)
  isActive       Boolean  @default(true)
  lastLoginAt    DateTime?
  
  // Security enhancements
  loginAttempts  Int      @default(0)
  lockedUntil    DateTime?
  permissions    String?  // JSON string for custom permissions
  branchId       String?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  sales              Sale[]
  purchases          Purchase[]
  expenses           Expense[]
  auditLogs          AuditLog[]
  refreshTokens      RefreshToken[]
  sessions           Session[]
  shifts             Shift[]
  transferRequests   StockTransfer[]  @relation("TransferRequester")
  transferApprovals  StockTransfer[]  @relation("TransferApprover")
  transferCompletions StockTransfer[] @relation("TransferCompleter")
  branch             Branch?          @relation(fields: [branchId], references: [id])

  @@index([email])
  @@index([role])
  @@index([branchId])
}

enum UserRole {
  ADMIN
  MANAGER
  CASHIER
  ACCOUNTANT
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// ============================================
// BRANCH MANAGEMENT
// ============================================

model Branch {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  address     String?
  phone       String?
  email       String?
  managerId   String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users              User[]
  stockTransfersFrom StockTransfer[]  @relation("TransferFrom")
  stockTransfersTo   StockTransfer[]  @relation("TransferTo")
  inventories        Inventory[]

  @@index([code])
  @@index([name])
}

// ============================================
// PRODUCT MANAGEMENT
// ============================================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  // Arabic name
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  products      Product[]
  subCategories SubCategory[]

  @@index([name])
}

model SubCategory {
  id          String   @id @default(cuid())
  name        String
  nameAr      String?  // Arabic name
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  category Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([categoryId])
  @@unique([name, categoryId])
}

model Product {
  id              String   @id @default(cuid())
  name            String
  nameAr          String?  // Arabic name
  barcode         String   @unique
  categoryId      String
  subCategoryId   String?
  supplierId      String?
  image           String?  // Product image URL or base64
  purchasePrice   Float    @default(0)
  sellingPrice    Float    @default(0)
  taxPercentage   Float    @default(0)
  minStockLevel   Int      @default(10)
  maxStockLevel   Int      @default(100)
  unit            String   @default("piece") // piece, kg, liter, etc.
  variants        String?  // JSON field for product variants (size, color, etc.)
  expiryDate      DateTime?
  expiryAlertDays Int      @default(30)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  category        Category           @relation(fields: [categoryId], references: [id])
  subCategory     SubCategory?       @relation(fields: [subCategoryId], references: [id])
  supplier        Supplier?          @relation(fields: [supplierId], references: [id])
  batches         ProductBatch[]
  saleItems       SaleItem[]
  purchaseItems   PurchaseItem[]
  stockMovements  StockMovement[]
  priceHistory    ProductPriceHistory[]
  productVariants ProductVariant[]

  @@index([barcode])
  @@index([name])
  @@index([categoryId])
  @@index([subCategoryId])
  @@index([supplierId])
}

model ProductVariant {
  id          String   @id @default(cuid())
  name        String   // e.g., "Size", "Color"
  productId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  product      Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantItems ProductVariantItem[]

  @@index([productId])
}

model ProductVariantItem {
  id              String   @id @default(cuid())
  variantId       String
  productId       String   // For quick lookup
  name            String   // e.g., "Small", "Red"
  sku             String?  // Unique SKU for this variant
  priceAdjustment Float    @default(0) // Price difference from base
  stock           Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  productVariant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([productId])
  @@unique([variantId, name])
}

model ProductBatch {
  id             String   @id @default(cuid())
  productId      String
  batchNumber    String
  quantity       Int      @default(0)
  purchasePrice  Float
  expirationDate DateTime?
  isExpired      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  product     Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems   SaleItem[]
  returnItems ReturnItem[]

  @@unique([productId, batchNumber])
  @@index([productId])
  @@index([expirationDate])
}

model ProductPriceHistory {
  id           String   @id @default(cuid())
  productId    String
  oldPrice     Float
  newPrice     Float
  priceType    String   // "purchase" or "selling"
  changedBy    String
  changeReason String?
  createdAt    DateTime @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
}

// ============================================
// SUPPLIER & CUSTOMER MANAGEMENT
// ============================================

model Supplier {
  id          String   @id @default(cuid())
  name        String
  phone       String?
  email       String?
  address     String?
  balance     Float    @default(0) // Amount owed to supplier
  creditLimit Float    @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  purchases Purchase[]
  products  Product[]

  @@index([name])
  @@index([phone])
}

model Customer {
  id             String   @id @default(cuid())
  name           String
  phone          String?  @unique
  email          String?
  address        String?
  creditBalance  Float    @default(0) // Store credit available
  totalPurchased Float    @default(0)
  loyaltyPoints  Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  sales   Sale[]
  returns Return[]

  @@index([name])
  @@index([phone])
}

// ============================================
// SALES & TRANSACTIONS
// ============================================

model Sale {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique
  customerId     String?
  shiftId        String?
  subtotal       Float         @default(0)
  taxAmount      Float         @default(0)
  discountAmount Float         @default(0)
  discountType   String?       @default("fixed") // "fixed" or "percentage"
  totalAmount    Float         @default(0)
  paymentMethod  PaymentMethod
  paymentStatus  PaymentStatus @default(COMPLETED)
  notes          String?
  createdBy      String
  branchId       String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  customer Customer? @relation(fields: [customerId], references: [id])
  user     User      @relation(fields: [createdBy], references: [id])
  shift    Shift?    @relation(fields: [shiftId], references: [id])
  items    SaleItem[]
  payments Payment[]
  returns  Return[]

  @@index([invoiceNumber])
  @@index([customerId])
  @@index([createdBy])
  @@index([createdAt])
  @@index([shiftId])
  @@index([branchId])
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  CREDIT
  MIXED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  PARTIAL
  REFUNDED
  CANCELLED
}

model SaleItem {
  id             String  @id @default(cuid())
  saleId         String
  productBatchId String
  productId      String
  quantity       Int
  unitPrice      Float
  taxAmount      Float   @default(0)
  discountAmount Float   @default(0)
  discountType   String? @default("fixed") // "fixed" or "percentage"
  totalAmount    Float   @default(0)
  costPrice      Float   @default(0) // For COGS calculation

  // Relations
  sale         Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id])
  productBatch ProductBatch @relation(fields: [productBatchId], references: [id])

  @@index([saleId])
  @@index([productId])
  @@index([productBatchId])
}

// ============================================
// PAYMENTS (Multiple payments per sale)
// ============================================

model Payment {
  id            String        @id @default(cuid())
  saleId        String
  amount        Float
  paymentMethod PaymentMethod
  reference     String? // Transaction reference, check number, etc.
  notes         String?
  createdBy     String
  createdAt     DateTime      @default(now())

  // Relations
  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([createdAt])
}

// ============================================
// RETURNS
// ============================================

model Return {
  id           String        @id @default(cuid())
  returnNumber String        @unique
  saleId       String?
  customerId   String?
  returnType   ReturnType
  totalAmount  Float         @default(0)
  reason       String?
  status       ReturnStatus  @default(PENDING)
  processedBy  String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  sale     Sale?       @relation(fields: [saleId], references: [id])
  customer Customer?   @relation(fields: [customerId], references: [id])
  items    ReturnItem[]

  @@index([returnNumber])
  @@index([saleId])
  @@index([customerId])
  @@index([createdAt])
}

enum ReturnType {
  FULL
  PARTIAL
  EXCHANGE
}

enum ReturnStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
}

model ReturnItem {
  id             String  @id @default(cuid())
  returnId       String
  productId      String
  productBatchId String?
  quantity       Int
  unitPrice      Float
  totalAmount    Float
  reason         String?

  // Relations
  return       Return       @relation(fields: [returnId], references: [id], onDelete: Cascade)
  productBatch ProductBatch? @relation(fields: [productBatchId], references: [id])

  @@index([returnId])
  @@index([productId])
}

// ============================================
// PURCHASES & PROCUREMENT
// ============================================

model Purchase {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique
  supplierId     String
  subtotal       Float         @default(0)
  taxAmount      Float         @default(0)
  totalAmount    Float         @default(0)
  paymentStatus  PaymentStatus @default(PENDING)
  paymentMethod  PaymentMethod?
  notes          String?
  createdBy      String
  branchId       String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  supplier Supplier      @relation(fields: [supplierId], references: [id])
  user     User          @relation(fields: [createdBy], references: [id])
  items    PurchaseItem[]

  @@index([invoiceNumber])
  @@index([supplierId])
  @@index([createdAt])
  @@index([branchId])
}

model PurchaseItem {
  id             String    @id @default(cuid())
  purchaseId     String
  productId      String
  batchNumber    String
  quantity       Int
  purchasePrice  Float
  expirationDate DateTime?
  totalAmount    Float     @default(0)

  // Relations
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])

  @@index([purchaseId])
  @@index([productId])
}

// ============================================
// EXPENSES & ACCOUNTING
// ============================================

model Expense {
  id            String          @id @default(cuid())
  title         String
  description   String?
  amount        Float
  category      ExpenseCategory
  paymentMethod PaymentMethod   @default(CASH)
  receiptUrl    String?
  createdBy     String
  branchId      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  user User @relation(fields: [createdBy], references: [id])

  @@index([category])
  @@index([createdAt])
  @@index([branchId])
}

enum ExpenseCategory {
  RENT
  UTILITIES
  SALARIES
  MARKETING
  MAINTENANCE
  SUPPLIES
  INSURANCE
  TAXES
  OTHER
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

model Inventory {
  id          String   @id @default(cuid())
  productId   String
  branchId    String
  quantity    Int      @default(0)
  reservedQty Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  branch Branch @relation(fields: [branchId], references: [id])
  
  @@unique([productId, branchId])
  @@index([productId])
  @@index([branchId])
}

model StockMovement {
  id          String            @id @default(cuid())
  productId   String
  type        StockMovementType
  quantity    Int
  reason      String?
  referenceId String? // Sale ID, Purchase ID, Transfer ID, etc.
  branchId    String?
  createdBy   String
  createdAt   DateTime          @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([branchId])
}

enum StockMovementType {
  SALE
  PURCHASE
  ADJUSTMENT
  RETURN
  DAMAGE
  EXPIRED
  TRANSFER_IN
  TRANSFER_OUT
}

model StockTransfer {
  id             String          @id @default(cuid())
  transferNumber String          @unique
  fromBranchId   String
  toBranchId     String
  status         TransferStatus  @default(PENDING)
  notes          String?
  requestedBy    String
  approvedBy     String?
  completedBy    String?
  requestedAt    DateTime        @default(now())
  approvedAt     DateTime?
  completedAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relations
  fromBranch Branch             @relation("TransferFrom", fields: [fromBranchId], references: [id])
  toBranch   Branch             @relation("TransferTo", fields: [toBranchId], references: [id])
  requester  User               @relation("TransferRequester", fields: [requestedBy], references: [id])
  approver   User?              @relation("TransferApprover", fields: [approvedBy], references: [id])
  completer  User?              @relation("TransferCompleter", fields: [completedBy], references: [id])
  items      StockTransferItem[]

  @@index([transferNumber])
  @@index([fromBranchId])
  @@index([toBranchId])
  @@index([status])
}

enum TransferStatus {
  PENDING
  APPROVED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model StockTransferItem {
  id         String @id @default(cuid())
  transferId String
  productId  String
  quantity   Int
  notes      String?

  // Relations
  transfer StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  @@index([transferId])
  @@index([productId])
}

// ============================================
// SHIFT MANAGEMENT
// ============================================

model Shift {
  id              String   @id @default(cuid())
  userId          String
  branchId        String?
  openingBalance  Float    @default(0)
  closingBalance  Float?
  cashSales       Float    @default(0)
  cardSales       Float    @default(0)
  upiSales        Float    @default(0)
  creditSales     Float    @default(0)
  totalSales      Float    @default(0)
  totalRefunds    Float    @default(0)
  expenses        Float    @default(0)
  expectedBalance Float?
  difference      Float?
  status          String   @default("OPEN") // OPEN, CLOSED
  openedAt        DateTime @default(now())
  closedAt        DateTime?
  notes           String?

  // Relations
  user  User   @relation(fields: [userId], references: [id])
  sales Sale[]

  @@index([userId])
  @@index([branchId])
  @@index([status])
  @@index([openedAt])
}

// ============================================
// AUDIT & LOGGING
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String?
  oldValues  String? // JSON string
  newValues  String? // JSON string
  ipAddress  String?
  userAgent  String?
  branchId   String?
  sessionId  String?
  createdAt  DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@index([branchId])
}

// ============================================
// PERMISSIONS
// ============================================

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  module          String // e.g., "sales", "products", "inventory"
  action          String // e.g., "create", "read", "update", "delete"
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  rolePermissions RolePermission[]

  @@index([name])
  @@index([module])
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String // UserRole as string
  permissionId String
  createdAt    DateTime @default(now())

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

// ============================================
// CASH DRAWER MANAGEMENT
// ============================================

model CashDrawer {
  id              String   @id @default(cuid())
  openingBalance  Float    @default(0)
  closingBalance  Float?
  cashSales       Float    @default(0)
  cardSales       Float    @default(0)
  upiSales        Float    @default(0)
  expenses        Float    @default(0)
  expectedBalance Float?
  difference      Float?
  openedAt        DateTime @default(now())
  closedAt        DateTime?
  openedBy        String
  closedBy        String?
  branchId        String?
  status          String   @default("OPEN") // OPEN, CLOSED

  @@index([openedAt])
  @@index([status])
  @@index([branchId])
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  branchId    String? // For branch-specific settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([branchId])
}

// ============================================
// IMPORT LOG (Excel import tracking)
// ============================================

model ImportLog {
  id           String   @id @default(cuid())
  type         String // "products", "customers", "suppliers", etc.
  fileName     String
  totalRows    Int
  successCount Int
  errorCount   Int
  errors       String? // JSON string with error details
  status       String  @default("PROCESSING") // PROCESSING, COMPLETED, FAILED
  createdBy    String
  createdAt    DateTime @default(now())

  @@index([type])
  @@index([status])
  @@index([createdAt])
}
